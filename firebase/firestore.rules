rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    function notExpired(ts) {
      return ts == null || request.time < ts;
    }

    // Validation helpers for user profile doc (kept for compatibility)
    function hasValidProfile() {
      return
        (request.resource.data.profile.uid is string) &&
        (request.resource.data.profile.email is string || request.resource.data.profile.email == null) &&
        (request.resource.data.profile.displayName is string || request.resource.data.profile.displayName == null) &&
        (request.resource.data.profile.photoURL is string || request.resource.data.profile.photoURL == null);
    }
    function hasValidPermissions() {
      return
        (request.resource.data.permissions is map) &&
        (request.resource.data.permissions.zzq is bool) &&
        (request.resource.data.permissions.cc is bool) &&
        (request.resource.data.permissions.inhouse is bool);
    }

    // Users base doc
    match /users/{uid} {
      allow create: if isOwner(uid) && hasValidPermissions() && hasValidProfile();
      allow read: if isOwner(uid);
      allow update: if isOwner(uid) && hasValidPermissions() && hasValidProfile();
      allow delete: if false;
    }

    // ZZQ owner-only subtree (owner may manage all their ZZQ data)
    match /users/{uid}/sites/zzq/{document=**} {
      allow read, write: if isOwner(uid);
    }

    // Invites (under owner subtree)
    // Allows:
    // - Owners to create/list/revoke their invites
    // - Any signed-in user to GET a specific active invite by token (no LIST)
    match /users/{ownerId}/sites/zzq/invites/{token} {
      // Invitee preflight GET
      allow get: if isSignedIn()
                 && resource.data.status == "active"
                 && notExpired(resource.data.expiresAt);
  
      // Only the owner can list their invites
      allow list: if isOwner(ownerId);
  
      // Owner creates active invite
      allow create: if isOwner(ownerId)
        && request.resource.data.ownerId == ownerId
        && request.resource.data.status == "active";
  
      // Owner may revoke; accepting user may mark as used
      allow update: if (
        // Owner revoke/maintenance (owner cannot directly mark "used")
        (isOwner(ownerId) && !(request.resource.data.status == "used"))
        ||
        // Accepting user updates to "used"
        (isSignedIn()
         && resource.data.status == "active"
         && notExpired(resource.data.expiresAt)
         && request.resource.data.status == "used"
         && request.resource.data.usedBy == request.auth.uid)
      );
  
      // Owner may delete
      allow delete: if isOwner(ownerId);
    }

    // Commission slugs (global, for routing /commission/{slug})
    match /commissionSlugs/{slug} {
      // Publicly readable to resolve slugs to ownerId
      allow get, list: if true;

      // Create only by the owner, and only if not already taken
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && !exists(/databases/$(database)/documents/commissionSlugs/$(slug));

      // Update/Delete only by the owner who owns the slug
      allow update, delete: if isSignedIn()
        && resource.data.ownerId == request.auth.uid;
    }
  
    // Canonical Chats
    match /chats/{chatId} {
      // Create requires caller to be included in the participants array
      allow create: if isSignedIn()
        && (request.auth.uid in request.resource.data.participants);

      // Read/Update require caller to be an existing participant
      allow get, update: if isSignedIn()
        && (request.auth.uid in resource.data.participants);

      // Disallow chat enumeration and deletion
      allow list: if false;
      allow delete: if false;

      // Messages under a chat (permission derived from parent chat)
      match /messages/{messageId} {
        allow read, create: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow update, delete: if false;
      }
    }

    // Per-user Chat Summaries (owner and client)
    // Owner's summaries: owner can do anything; chat participants can create/update the owner's summary for discoverability
    match /users/{ownerId}/sites/cc/chats/{chatId} {
      allow read, list, delete: if isOwner(ownerId);
      allow create, update: if isOwner(ownerId) || (
        isSignedIn()
        && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants)
        && request.resource.data.ownerId == ownerId
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.chatId == chatId
      );
    }
    // Client/self summaries remain self-owned only
    match /users/{uid}/sites/cc/chats/{chatId} {
      allow read, write, list: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // Per-user Link Views
    match /users/{ownerId}/sites/zzq/clients/{clientId}/links/{linkId} {
      allow read, write, list, delete: if isOwner(ownerId);
    }
    match /users/{uid}/sites/cc/links/{linkId} {
      allow read, write, list, delete: if isOwner(uid);
    }

    // Notification tokens (per-user device tokens for FCM)
    match /users/{uid}/notificationTokens/{token} {
      allow read, write, list, delete: if isOwner(uid);
    }

    // Legacy explicit ZZQ matches (redundant with the zzq/** rule above, kept for clarity)
    match /users/{uid}/sites/zzq/clients/{clientId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/projects/{projectId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/projects/{projectId}/notes/{noteId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/notes/{noteId} {
      allow read, create, update, delete: if isOwner(uid);
    }

    // Masterwork claimed (invite-only)
    match /masterwork/claimed/{document=**} {
      // Access allowed if:
      // - Authenticated user with email mercysquadrant@gmail.com (admin), OR
      // - A document exists in the allowlist collection for the user's UID: /masterwork/claimed/allowlist/{uid}
      allow read, write: if isSignedIn() &&
        (request.auth.token.email == "mercysquadrant@gmail.com" ||
         exists(/databases/$(database)/documents/masterwork/claimed/allowlist/$(request.auth.uid)));
    }

    // Allow the admin (mercysquadrant) to manage the allowlist documents (grant/revoke)
    match /masterwork/claimed/allowlist/{uid} {
      // Admin may manage the allowlist documents
      allow create, update, delete, list: if isSignedIn() && request.auth.token.email == "mercysquadrant@gmail.com";
      // Admin and the user themselves may read their own allowlist entry
      allow get: if isSignedIn() && (request.auth.token.email == "mercysquadrant@gmail.com" || request.auth.uid == uid);
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}