rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    function notExpired(ts) {
      return ts == null || request.time < ts;
    }
    // Lightweight project admin check (single-admin model)
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == "mercysquadrant@gmail.com";
    }
    function chatHasParticipant(chatId, uid) {
      return uid != null
        && get(/databases/$(database)/documents/chats/$(chatId)).data.participants != null
        && (uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }
    function goteChatHasParticipant(chatId, uid) {
      return uid != null
        && get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants != null
        && (uid in get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
    }

    // Validation helpers for user profile doc (kept for compatibility)
    function hasValidProfile() {
      return
        (request.resource.data.profile.uid is string) &&
        (request.resource.data.profile.email is string || request.resource.data.profile.email == null) &&
        (request.resource.data.profile.displayName is string || request.resource.data.profile.displayName == null) &&
        (request.resource.data.profile.photoURL is string || request.resource.data.profile.photoURL == null);
    }
    function hasValidPermissions() {
      return
        (request.resource.data.permissions is map) &&
        (request.resource.data.permissions.teach is bool) &&
        (request.resource.data.permissions.zzq is bool) &&
        (request.resource.data.permissions.cc is bool) &&
        (request.resource.data.permissions.inhouse is bool) &&
        (request.resource.data.permissions.gote is bool);
    }

    // Users base doc
    // Owners may read/write their own profile. The project admin (mercysquadrant) may list/read/update
    // user documents to support administrative operations (for example, granting access by email).
    match /users/{uid} {
      // Owner or admin may create their profile document (bootstrap)
      allow create: if isOwner(uid) || isAdmin();
      // Owner or admin may read the profile
      allow get: if isOwner(uid) || isAdmin();
      // Admin may list users to enable lookup by email; listing is restricted to the admin account
      allow list: if isAdmin();
      // Owner or admin may update the profile
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if false;
    }

    // ZZQ owner-only subtree (owner may manage all their ZZQ data)
    match /users/{uid}/sites/zzq/{document=**} {
      allow read, write: if isOwner(uid);
    }

    // BigGote owner-only subtree (owner may manage all their BigGote data)
    match /users/{uid}/sites/gote/{document=**} {
      allow read, write: if isOwner(uid);
    }

    // Invites (under owner subtree)
    // Allows:
    // - Owners to create/list/revoke their invites
    // - Any signed-in user to GET a specific active invite by token (no LIST)
    match /users/{ownerId}/sites/zzq/invites/{token} {
      // Invitee preflight GET
      allow get: if isSignedIn()
                 && resource.data.status == "active"
                 && notExpired(resource.data.expiresAt);
  
      // Only the owner can list their invites
      allow list: if isOwner(ownerId);
  
      // Owner creates active invite
      allow create: if isOwner(ownerId)
        && request.resource.data.ownerId == ownerId
        && request.resource.data.status == "active";
  
      // Owner may revoke; accepting user may mark as used
      allow update: if (
        // Owner revoke/maintenance (owner cannot directly mark "used")
        (isOwner(ownerId) && !(request.resource.data.status == "used"))
        ||
        // Accepting user updates to "used"
        (isSignedIn()
         && resource.data.status == "active"
         && notExpired(resource.data.expiresAt)
         && request.resource.data.status == "used"
         && request.resource.data.usedBy == request.auth.uid)
      );
  
      // Owner may delete
      allow delete: if isOwner(ownerId);
    }

    // Invites for BigGote (under owner subtree)
    // Same semantics as ZZQ invites; tokens are not listable by invitees
    match /users/{ownerId}/sites/gote/invites/{token} {
      // Invitee preflight GET
      allow get: if isSignedIn()
                 && resource.data.status == "active"
                 && notExpired(resource.data.expiresAt);

      // Only the owner can list their invites
      allow list: if isOwner(ownerId);

      // Owner creates active invite
      allow create: if isOwner(ownerId)
        && request.resource.data.ownerId == ownerId
        && request.resource.data.status == "active";

      // Owner may revoke; accepting user may mark as used
      allow update: if (
        // Owner revoke/maintenance (owner cannot directly mark "used")
        (isOwner(ownerId) && !(request.resource.data.status == "used"))
        ||
        // Accepting user updates to "used"
        (isSignedIn()
         && resource.data.status == "active"
         && notExpired(resource.data.expiresAt)
         && request.resource.data.status == "used"
         && request.resource.data.usedBy == request.auth.uid)
      );

      // Owner may delete
      allow delete: if isOwner(ownerId);
    }

    // Commission slugs (global, for routing /commission/{slug})
    match /commissionSlugs/{slug} {
      // Publicly readable to resolve slugs to ownerId
      allow get, list: if true;

      // Create only by the owner, and only if not already taken
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && !exists(/databases/$(database)/documents/commissionSlugs/$(slug));

      // Update/Delete only by the owner who owns the slug
      allow update, delete: if isSignedIn()
        && resource.data.ownerId == request.auth.uid;
    }
  
    // Canonical Chats
    match /chats/{chatId} {
      // Create requires caller to be included in the participants array
      allow create: if isSignedIn()
        && (request.auth.uid in request.resource.data.participants);

      // Read/Update require caller to be an existing participant
      allow get, update: if isSignedIn()
        && (request.auth.uid in resource.data.participants);

      // Disallow chat enumeration and deletion
      allow list: if false;
      allow delete: if false;

      // Messages under a chat (permission derived from parent chat)
      match /messages/{messageId} {
        allow read, create: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow update, delete: if false;
      }
    }

    // BigGote canonical chats (separate collection)
    match /goteChats/{chatId} {
      // Create requires caller to be included in the participants array
      allow create: if isSignedIn()
        && (request.auth.uid in request.resource.data.participants);

      // Read/Update require caller to be an existing participant
      allow get, update: if isSignedIn()
        && (request.auth.uid in resource.data.participants);

      // Disallow chat enumeration and deletion
      allow list: if false;
      allow delete: if false;

      // Profiles (per-chat display profiles; readable by participants; update allowed by any chat participant)
      match /profiles/{uid} {
        allow read: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        // Allow any chat participant to create/update any profile in this chat to support "Omnipotent Narrator" actions.
        allow create, update: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        allow delete: if false;
      }

      // Characters (per-chat, per-player; player-provided, not editable post-create)
      match /characters/{uid} {
        // Visible to chat participants
        allow read: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        // Only the owner of uid may create their own character profile
        allow create: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants)
          && (request.auth.uid == uid);
        // Prevent edits by players to keep character info immutable during play (admin may update via console)
        allow update, delete: if false;
      }

      // States (per-chat, per-player; Narrator/AI-managed)
      match /states/{uid} {
        // Visible to chat participants
        allow read: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        // Create/Update allowed by any chat participant (client executes AI/Narrator actions)
        allow create, update: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        allow delete: if false;
      }

      // Inventories (per-chat, per-player)
      // Allows the AI/Narrator (executed by either participant) to modify either participant's inventory.
      match /inventories/{uid} {
        // Visible to chat participants
        allow read: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        // Create/Update/Delete allowed by any chat participant
        allow create, update, delete: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
      }

      // Messages under a chat (permission derived from parent chat)
      match /messages/{messageId} {
        allow read, create: if isSignedIn()
          && (request.auth.uid in
               get(/databases/$(database)/documents/goteChats/$(chatId)).data.participants);
        allow update, delete: if false;
      }
    }

    // BigGote per-user Chat Summaries (owner + participant mirroring)
    match /users/{ownerId}/sites/gote/chats/{chatId} {
      // Owner can manage their summaries fully
      allow read, list, delete: if isOwner(ownerId);
      // Allow chat participants to create/update the owner's summary for discoverability
      allow create, update: if isOwner(ownerId) || (
        isSignedIn()
        && goteChatHasParticipant(chatId, request.auth.uid)
        && request.resource.data.chatId == chatId
      );
    }

    // Per-user Chat Summaries (owner and client)
    // Owner's summaries: owner can do anything; chat participants can create/update the owner's summary for discoverability
    match /users/{ownerId}/sites/cc/chats/{chatId} {
      allow read, list, delete: if isOwner(ownerId);
      allow create, update: if isOwner(ownerId) || (
        isSignedIn()
        && chatHasParticipant(chatId, request.auth.uid)
        && request.resource.data.ownerId == ownerId
        && request.resource.data.chatId == chatId
        && (
          request.resource.data.userId == request.auth.uid
          || chatHasParticipant(chatId, request.resource.data.userId)
        )
      );
    }
    // Client/self summaries remain self-owned only
    match /users/{uid}/sites/cc/chats/{chatId} {
      allow read, write, list: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // Per-user Link Views
    match /users/{ownerId}/sites/zzq/clients/{clientId}/links/{linkId} {
      allow read, write, list, delete: if isOwner(ownerId);
    }
    match /users/{uid}/sites/cc/links/{linkId} {
      allow read, write, list, delete: if isOwner(uid);
    }

    // Notification tokens (per-user device tokens for FCM)
    match /users/{uid}/notificationTokens/{token} {
      allow read, write, list, delete: if isOwner(uid);
    }

    // Legacy explicit ZZQ matches (redundant with the zzq/** rule above, kept for clarity)
    match /users/{uid}/sites/zzq/clients/{clientId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/projects/{projectId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/projects/{projectId}/notes/{noteId} {
      allow read, create, update, delete: if isOwner(uid);
    }
    match /users/{uid}/sites/zzq/clients/{clientId}/notes/{noteId} {
      allow read, create, update, delete: if isOwner(uid);
    }

    // Masterwork claimed (invite-only)
    match /masterwork/claimed/{document=**} {
      // Access allowed if:
      // - Authenticated user with email mercysquadrant@gmail.com (admin), OR
      // - A document exists in the allowlist collection for the user's UID: /masterwork/claimed/allowlist/{uid}
      allow read, write: if isSignedIn() &&
        (request.auth.token.email == "mercysquadrant@gmail.com" ||
         exists(/databases/$(database)/documents/masterwork/claimed/allowlist/$(request.auth.uid)));
    }

    // Allow the admin (mercysquadrant) to manage the allowlist documents (grant/revoke)
    match /masterwork/claimed/allowlist/{uid} {
      // Admin may manage the allowlist documents
      allow create, update, delete, list: if isSignedIn() && request.auth.token.email == "mercysquadrant@gmail.com";
      // Admin and the user themselves may read their own allowlist entry
      allow get: if isSignedIn() && (request.auth.token.email == "mercysquadrant@gmail.com" || request.auth.uid == uid);
    }

    // Teach Intro Scheduling
    // Collection for 15-minute intro requests created by signed-in users.
    // Access:
    // - create: any signed-in user may create their own request (status="requested")
    // - get: admin can read all; users can read their own docs
    // - list/update/delete: admin only
    match /teachIntros/{introId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == "requested";
      allow get: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow list: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Day Planner (admin-only)
    // Day docs keyed by YYYY-MM-DD with subcollection /items
    match /plannerDays/{dayId} {
      allow get, list, create, update, delete: if isAdmin();
      match /items/{itemId} {
        allow get, list, create, update, delete: if isAdmin();
      }
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}